name: PR Quality Check

on:
    pull_request:
        types: [opened, edited, synchronize, reopened]

permissions:
    pull-requests: write
    contents: read

jobs:
    validate-pr:
        runs-on: ubuntu-latest
        steps:
            - name: Validate PR Description
              uses: actions/github-script@v7
              with:
                  script: |
                      const prBody = context.payload.pull_request.body || '';
                      const prTitle = context.payload.pull_request.title;
                      const prNumber = context.payload.pull_request.number;
                      
                      const errors = [];
                      const warnings = [];
                      
                      // Check 1: PR has a description
                      if (prBody.length < 50) {
                        errors.push('âŒ PR description is too short (minimum 50 characters required)');
                      }
                      
                      // Check 2: PR links an issue or explains why not
                      const hasIssueLink = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#\d+/i.test(prBody) || 
                                          /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+https:\/\/github\.com\/.+\/issues\/\d+/i.test(prBody);
                      
                      if (!hasIssueLink) {
                        warnings.push('âš ï¸ No linked issue found. Consider linking with "Closes #123" or explain why not needed');
                      }
                      
                      // Check 3: Type of change is selected
                      const hasTypeSelected = /- \[x\]/i.test(prBody);
                      if (!hasTypeSelected) {
                        warnings.push('âš ï¸ Please select at least one "Type of Change" checkbox');
                      }
                      
                      // Check 4: Testing checklist progress
                      const totalChecks = (prBody.match(/- \[ \]/g) || []).length;
                      const completedChecks = (prBody.match(/- \[x\]/gi) || []).length;
                      
                      if (totalChecks > 0) {
                        const completionRate = (completedChecks / totalChecks) * 100;
                        if (completionRate < 50) {
                          warnings.push(`âš ï¸ Only ${completedChecks}/${totalChecks} checkboxes completed (${completionRate.toFixed(0)}%). Please complete the PR template`);
                        }
                      }
                      
                      // Check 5: No placeholder text
                      const hasPlaceholders = /<!--.*?-->/.test(prBody.replace(/<!--[^>]*-->/g, '')) || 
                                             /\(describe (?:below|here)\)/i.test(prBody) ||
                                             /\(issue_number\)/i.test(prBody);
                      
                      if (hasPlaceholders) {
                        warnings.push('âš ï¸ Placeholder text detected. Please replace with actual content');
                      }
                      
                      // Check 6: Title follows conventional commits (warning only)
                      const conventionalCommitPattern = /^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?!?:.+/;
                      if (!conventionalCommitPattern.test(prTitle)) {
                        warnings.push('âš ï¸ PR title should follow Conventional Commits format (e.g., "feat: add new feature" or "fix: resolve bug")');
                      }
                      
                      // Report results
                      if (errors.length > 0 || warnings.length > 0) {
                        let comment = '## ðŸ” PR Quality Check Results\n\n';
                        
                        if (errors.length > 0) {
                          comment += '### âŒ Errors (Must Fix)\n\n';
                          errors.forEach(err => comment += `${err}\n`);
                          comment += '\n';
                        }
                        
                        if (warnings.length > 0) {
                          comment += '### âš ï¸ Warnings (Recommended Fixes)\n\n';
                          warnings.forEach(warn => comment += `${warn}\n`);
                          comment += '\n';
                        }
                        
                        comment += '---\n';
                        comment += 'ðŸ’¡ **Tip:** Address these issues to improve PR quality and speed up review time.\n';
                        comment += 'ðŸ“‹ See the [PR template](.github/PULL_REQUEST_TEMPLATE.md) for guidance.\n';
                        
                        // Post comment only if there are errors
                        if (errors.length > 0) {
                          await github.rest.issues.createComment({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            issue_number: prNumber,
                            body: comment
                          });
                          
                          core.setFailed('PR quality checks failed. Please address the errors above.');
                        } else {
                          // Just log warnings
                          console.log(comment);
                        }
                      } else {
                        console.log('âœ… All PR quality checks passed!');
                      }
