name: PR Conflict Detector

on:
    pull_request:
        types: [opened, synchronize, reopened]
    # Also run when main branch is updated
    push:
        branches:
            - main

permissions:
    pull-requests: write
    contents: read

jobs:
    check-conflicts:
        runs-on: ubuntu-latest
        steps:
            - name: Check for merge conflicts
              uses: actions/github-script@v7
              with:
                  script: |
                      let prs = [];
                      
                      if (context.eventName === 'pull_request') {
                        // Check current PR only
                        prs = [context.payload.pull_request];
                      } else {
                        // Check all open PRs when main is updated
                        const { data: openPRs } = await github.rest.pulls.list({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          state: 'open',
                          per_page: 100
                        });
                        prs = openPRs;
                      }
                      
                      for (const pr of prs) {
                        // Get fresh PR data
                        const { data: prData } = await github.rest.pulls.get({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          pull_number: pr.number
                        });
                        
                        if (prData.mergeable_state === 'dirty' || prData.mergeable === false) {
                          // Get existing comments
                          const { data: comments } = await github.rest.issues.listComments({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            issue_number: pr.number
                          });
                          
                          const hasConflictComment = comments.some(c => 
                            c.body.includes('‚ö†Ô∏è Merge Conflict Detected') &&
                            c.user.type === 'Bot'
                          );
                          
                          // Only comment if no recent conflict comment exists
                          if (!hasConflictComment) {
                            const comment = `## ‚ö†Ô∏è Merge Conflict Detected\n\n` +
                              `This PR has merge conflicts with the \`main\` branch that must be resolved before it can be merged.\n\n` +
                              `### üîß How to Resolve:\n\n` +
                              `**Option 1: Update from main**\n` +
                              `\`\`\`bash\n` +
                              `git checkout main\n` +
                              `git pull origin main\n` +
                              `git checkout ${prData.head.ref}\n` +
                              `git merge main\n` +
                              `# Resolve conflicts in your editor\n` +
                              `git add .\n` +
                              `git commit -m "chore: resolve merge conflicts with main"\n` +
                              `git push\n` +
                              `\`\`\`\n\n` +
                              `**Option 2: Rebase (advanced)**\n` +
                              `\`\`\`bash\n` +
                              `git checkout ${prData.head.ref}\n` +
                              `git fetch origin\n` +
                              `git rebase origin/main\n` +
                              `# Resolve conflicts in your editor\n` +
                              `git add .\n` +
                              `git rebase --continue\n` +
                              `git push --force-with-lease\n` +
                              `\`\`\`\n\n` +
                              `---\n` +
                              `üí° Need help? Check out [GitHub's guide on resolving merge conflicts](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/addressing-merge-conflicts/resolving-a-merge-conflict-using-the-command-line).\n`;
                            
                            await github.rest.issues.createComment({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number: pr.number,
                              body: comment
                            });
                            
                            console.log(`Posted conflict notice for PR #${pr.number}`);
                          }
                        } else if (prData.mergeable === true) {
                          // PR is mergeable - remove old conflict comments if any
                          const { data: comments } = await github.rest.issues.listComments({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            issue_number: pr.number
                          });
                          
                          const conflictComments = comments.filter(c => 
                            c.body.includes('‚ö†Ô∏è Merge Conflict Detected') &&
                            c.user.type === 'Bot'
                          );
                          
                          for (const comment of conflictComments) {
                            await github.rest.issues.deleteComment({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              comment_id: comment.id
                            });
                            console.log(`Removed resolved conflict comment from PR #${pr.number}`);
                          }
                        }
                      }
                      
                      console.log('Conflict check completed');
